<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jukebox Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg: #121212; --surface: #1e1e1e; --surface-hover: #2a2a2a; --text: #ffffff; --text-dim: #b3b3b3; --border: #333; --accent: #ffffff; --success: #00e676; --error: #ff5252; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }

        /* TOAST NOTIFICATIONS */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; background: var(--surface); color: white; padding: 12px 20px; border-radius: 30px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; gap: 10px; animation: slideIn 0.3s ease-out forwards; font-size: 0.9rem; }
        .toast.success i { color: var(--success); } .toast.error i { color: var(--error); }
        .toast.hiding { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* UTILITÁRIOS */
        .view { display: none; width: 100%; height: 100%; }
        .view.active { display: flex; }
        .fade-transition { transition: opacity 0.4s ease; } .fade-out { opacity: 0; } .fade-in { opacity: 1; }

        /* AUTH */
        .auth-container { width: 100%; height: 100%; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
        .auth-box { width: 400px; background: var(--surface); border-radius: 12px; padding: 40px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .auth-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .auth-desc { text-align: center; color: var(--text-dim); margin-bottom: 30px; font-size: 0.9rem; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px; }
        .form-input { width: 100%; background: #121212; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 6px; outline: none; font-size: 1rem; }
        .form-input:focus { border-color: #555; }
        .btn-primary { width: 100%; background: white; color: black; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        .btn-primary:hover { background: #ddd; }

        /* --- APP LAYOUT --- */
        .app-layout { display: grid; grid-template-columns: 1fr 340px; width: 100%; height: 100%; padding: 20px; gap: 20px; padding-bottom: 90px; }
        
        /* PALCO PRINCIPAL (CORRIGIDO PARA CENTRALIZAR) */
        .main-stage { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; /* Centraliza Verticalmente */
            position: relative; 
            height: 100%; 
            width: 100%;
        }
        
        /* HEADER DO USUÁRIO */
        .user-header {
            display: flex; align-items: center; justify-content: space-between;
            padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 15px;
        }
        .user-pill { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; background: var(--accent); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; }
        .user-name { font-size: 0.9rem; font-weight: 600; color: #fff; }
        .header-actions { display: flex; gap: 8px; }
        .action-btn { width: 32px; height: 32px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .action-btn:hover { background: #333; color: #fff; }
        .action-btn.logout:hover { border-color: var(--error); color: var(--error); }

        /* BUSCA */
        .search-wrapper { position: absolute; top: 0; width: 100%; max-width: 600px; z-index: 50; }
        .search-container { width: 100%; background: var(--surface); border-radius: 8px; padding: 12px 20px; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border: 1px solid transparent; }
        .search-container input { background: transparent; border: none; color: white; flex: 1; outline: none; font-size: 1rem; }
        .btn-add { background: white; color: black; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .search-results { position: absolute; top: 110%; left: 0; width: 100%; background: #252525; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); overflow: hidden; display: none; flex-direction: column; max-height: 400px; overflow-y: auto; z-index: 100; border: 1px solid #333; }
        /* Scrollbar Busca */
        .search-results::-webkit-scrollbar { width: 6px; } .search-results::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .result-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .result-item:hover { background: #3a3a3a; }
        .result-thumb-wrapper { width: 80px; height: 45px; flex-shrink: 0; background: #000; border-radius: 4px; overflow: hidden; }
        .result-thumb { width: 100%; height: 100%; object-fit: cover; }
        .result-title { font-size: 0.9rem; font-weight: 500; color: #fff; overflow: hidden; text-overflow: ellipsis; }

        /* CAPA (CORRIGIDA) */
        .cover-area { 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 0; /* Remove offset superior */
            padding-top: 40px; /* Compensação visual para a barra de busca */
        }
        .art-wrapper { width: 320px; height: 320px; border-radius: 16px; background: #181818; box-shadow: 0 20px 60px rgba(0,0,0,0.5); margin-bottom: 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .album-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .idle-placeholder { color: #333; display: flex; flex-direction: column; align-items: center; }
        .idle-placeholder i { font-size: 80px; margin-bottom: 20px; }
        .track-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; color: white; max-width: 600px; }
        .track-artist { font-size: 1rem; color: var(--text-dim); }

        /* FILA */
        .queue-panel { background: var(--surface); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; border: 1px solid var(--border); overflow: hidden; }
        .tabs { display: flex; gap: 20px; margin-bottom: 15px; padding-bottom: 5px; }
        .tab-btn { background: none; border: none; color: var(--text-dim); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; cursor: pointer; padding-bottom: 5px; border-bottom: 2px solid transparent; transition: 0.2s;}
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: white; border-bottom-color: white; }
        .list-container { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 4px; padding-right: 5px; }
        .list-container::-webkit-scrollbar { width: 4px; } .list-container::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        .list-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 6px; cursor: pointer; transition: 0.1s; }
        .list-item:hover { background: var(--surface-hover); }
        .list-item.active { background: rgba(255, 255, 255, 0.1); border-left: 3px solid var(--accent); cursor: default; }
        .l-img { width: 40px; height: 40px; border-radius: 4px; background: #000; object-fit: cover; }
        .l-meta { flex: 1; overflow: hidden; }
        .l-name { font-size: 0.9rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .l-user { font-size: 0.75rem; color: var(--text-dim); }
        .l-icon { display: none; color: var(--accent); font-size: 0.8rem; }
        .l-action { color: var(--text-dim); font-size: 0.9rem; }

        /* PLAYER BAR */
        .player-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: #181818; border-top: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 100; }
        .pb-left, .pb-right { width: 250px; display: flex; align-items: center; gap: 15px; }
        .pb-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; max-width: 600px; }
        .mini-cover { width: 56px; height: 56px; border-radius: 4px; background: #333; object-fit: cover; display: none; }
        .pb-info { flex: 1; overflow: hidden; }
        .pb-info h4 { font-size: 0.95rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pb-info span { font-size: 0.8rem; color: var(--text-dim); }
        .controls { display: flex; align-items: center; gap: 30px; margin-bottom: 5px; }
        .btn-ctrl { background: none; border: none; color: var(--text-dim); font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .btn-ctrl:hover { color: white; }
        .btn-play { width: 40px; height: 40px; border-radius: 50%; background: white; color: black; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: transform 0.2s; }
        .btn-play:hover { transform: scale(1.05); }

        /* --- SLIDERS (CROSS-BROWSER FIXED) --- */
        .progress-container { width: 100%; display: flex; align-items: center; gap: 15px; font-size: 0.75rem; color: var(--text-dim); }
        .vol-container { display: flex; align-items: center; gap: 10px; width: 120px; }

        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; cursor: pointer; }
        /* Chrome */
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #333; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; box-shadow: 0 0 10px rgba(255,255,255,0.5); opacity: 0; transition: opacity 0.2s; }
        /* Firefox */
        input[type=range]::-moz-range-track { height: 4px; background: #333; border-radius: 2px; }
        input[type=range]::-moz-range-thumb { height: 12px; width: 12px; border: none; border-radius: 50%; background: #fff; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        input[type=range]::-moz-range-progress { background-color: var(--accent); height: 4px; border-radius: 2px; }
        
        /* Hover */
        .progress-container:hover input[type=range]::-webkit-slider-thumb, .vol-container:hover input[type=range]::-webkit-slider-thumb { opacity: 1; }
        .progress-container:hover input[type=range]::-moz-range-thumb, .vol-container:hover input[type=range]::-moz-range-thumb { opacity: 1; }

        /* Modal Admin */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 400px; background: var(--surface); padding: 30px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { cursor: pointer; font-size: 1.2rem; }

        @media (max-width: 768px) {
            .app-layout { grid-template-columns: 1fr; padding-bottom: 140px; }
            .queue-panel, .pb-right { display: none; }
            .player-bar { flex-direction: column; height: auto; padding: 15px; background: rgba(24, 24, 24, 0.95); }
            .pb-left, .pb-center { width: 100%; max-width: none; }
        }
    </style>
</head>
<body>

    <div id="toastContainer" class="toast-container"></div>

    <div id="setupView" class="view auth-container">
        <div class="auth-box">
            <div class="auth-title">Bem-vindo à Jukebox</div>
            <div class="auth-desc">Configure o Administrador.</div>
            <div class="form-group"><label>Nome</label><input type="text" id="setupName" class="form-input"></div>
            <div class="form-group"><label>Sobrenome</label><input type="text" id="setupLast" class="form-input"></div>
            <div class="form-group"><label>Usuário</label><input type="text" id="setupUser" class="form-input"></div>
            <div class="form-group"><label>Senha</label><input type="password" id="setupPass" class="form-input"></div>
            <button class="btn-primary" onclick="doSetup()">Criar Administrador</button>
        </div>
    </div>

    <div id="loginView" class="view auth-container">
        <div class="auth-box">
            <div class="auth-title">Login</div>
            <div class="auth-desc">Entre para adicionar músicas.</div>
            <div class="form-group"><label>Usuário</label><input type="text" id="loginUser" class="form-input"></div>
            <div class="form-group"><label>Senha</label><input type="password" id="loginPass" class="form-input"></div>
            <button class="btn-primary" onclick="doLogin()">Entrar</button>
        </div>
    </div>

    <div id="appView" class="view">
        <div class="app-layout">
            <div class="main-stage">
                <div class="search-wrapper">
                    <div class="search-container">
                        <i class="fas fa-search" style="color: #666"></i>
                        <input type="text" id="urlInput" placeholder="Digite o nome da música..." autocomplete="off">
                        <div id="searchLoader" style="display:none; color:#fff"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </div>

                <div class="cover-area fade-transition" id="coverArea">
                    <div class="art-wrapper">
                        <div class="idle-placeholder" id="idleState"><i class="fas fa-compact-disc"></i><span>Aguardando Música</span></div>
                        <img id="heroCover" class="album-img fade-transition" src="">
                    </div>
                    <h1 class="track-title fade-transition" id="heroTitle">Jukebox Ready</h1>
                    <div class="track-artist fade-transition" id="heroStatus">Adicione uma música</div>
                </div>
            </div>

            <div class="queue-panel">
                <div class="user-header">
                    <div class="user-pill">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-name" id="displayUserName">Usuario</div>
                    </div>
                    <div class="header-actions">
                        <button class="action-btn" id="btnAdmin" title="Novo Usuário" onclick="openAdminModal()" style="display:none"><i class="fas fa-user-plus"></i></button>
                        <button class="action-btn logout" title="Sair" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('queue')">Fila</button>
                    <button class="tab-btn" onclick="switchTab('history')">Histórico</button>
                </div>
                <div class="list-container" id="listContainer"></div>
            </div>
        </div>

        <div class="player-bar">
            <div class="pb-left">
                <img id="miniCover" class="mini-cover" src="">
                <div class="pb-info"><h4 id="miniTitle"></h4><span id="miniStatus"></span></div>
            </div>
            <div class="pb-center">
                <div class="controls">
                    <button class="btn-ctrl" onclick="control('prev')"><i class="fas fa-backward-step"></i></button>
                    <button class="btn-ctrl btn-play" onclick="control('pause')"><i id="playIcon" class="fas fa-play"></i></button>
                    <button class="btn-ctrl" onclick="control('next')"><i class="fas fa-forward-step"></i></button>
                </div>
                <div class="progress-container">
                    <span id="currentTime">0:00</span>
                    <input type="range" id="progressBar" min="0" max="100" value="0">
                    <span id="totalTime">0:00</span>
                </div>
            </div>
            <div class="pb-right">
                <div class="vol-container">
                    <i class="fas fa-volume-high" style="font-size: 1rem; color:var(--text-dim)"></i>
                    <input type="range" id="volumeBar" min="0" max="130" value="100">
                </div>
            </div>
        </div>
    </div>

    <div id="adminModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Novo Usuário</h3>
                <div class="close-modal" onclick="closeAdminModal()">&times;</div>
            </div>
            <div class="form-group"><label>Nome</label><input type="text" id="newUserFirst" class="form-input"></div>
            <div class="form-group"><label>Sobrenome</label><input type="text" id="newUserLast" class="form-input"></div>
            <div class="form-group"><label>Usuário</label><input type="text" id="newUserUser" class="form-input"></div>
            <div class="form-group"><label>Senha</label><input type="password" id="newUserPass" class="form-input"></div>
            <button class="btn-primary" onclick="createUser()">Criar</button>
        </div>
    </div>

    <script>
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
            toast.className = `toast ${type}`; toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

        const views = { setup: document.getElementById('setupView'), login: document.getElementById('loginView'), app: document.getElementById('appView') };
        let token = localStorage.getItem('jukebox_token');
        let socket = null;

        async function init() {
            if (token) { showView('app'); connectSocket(); }
            else {
                const res = await fetch('/api/auth/check-init');
                const data = await res.json();
                if (data.needsSetup) showView('setup'); else showView('login');
            }
        }

        function showView(name) { Object.values(views).forEach(el => el.classList.remove('active')); views[name].classList.add('active'); }

        async function doSetup() {
            const body = { username: document.getElementById('setupUser').value, password: document.getElementById('setupPass').value, name: document.getElementById('setupName').value, lastname: document.getElementById('setupLast').value };
            try {
                const res = await fetch('/api/auth/setup', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.token) { localStorage.setItem('jukebox_token', data.token); token = data.token; showView('app'); connectSocket(); showToast('Admin configurado!'); }
                else showToast(data.error, 'error');
            } catch(e) { showToast('Erro de conexão', 'error'); }
        }

        async function doLogin() {
            const body = { username: document.getElementById('loginUser').value, password: document.getElementById('loginPass').value };
            try {
                const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.token) { localStorage.setItem('jukebox_token', data.token); token = data.token; showView('app'); connectSocket(); showToast(`Olá, ${data.user.name}!`); }
                else showToast(data.error, 'error');
            } catch(e) { showToast('Erro de conexão', 'error'); }
        }

        function doLogout() { localStorage.removeItem('jukebox_token'); location.reload(); }
        function openAdminModal() { document.getElementById('adminModal').style.display = 'flex'; }
        function closeAdminModal() { document.getElementById('adminModal').style.display = 'none'; }
        
        async function createUser() {
            const body = { username: document.getElementById('newUserUser').value, password: document.getElementById('newUserPass').value, name: document.getElementById('newUserFirst').value, lastname: document.getElementById('newUserLast').value };
            try {
                const res = await fetch('/api/auth/register', { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, body: JSON.stringify(body) });
                if (res.ok) { showToast('Usuário criado!'); closeAdminModal(); document.querySelectorAll('#adminModal input').forEach(i => i.value = ''); }
                else { const data = await res.json(); showToast(data.error, 'error'); }
            } catch(e) { showToast('Erro ao criar', 'error'); }
        }

        // APP LOGIC
        const els = {
            url: document.getElementById('urlInput'), searchResults: document.getElementById('searchResults'),
            searchLoader: document.getElementById('searchLoader'), coverArea: document.getElementById('coverArea'),
            heroTitle: document.getElementById('heroTitle'), heroStatus: document.getElementById('heroStatus'),
            heroCover: document.getElementById('heroCover'), idleState: document.getElementById('idleState'),
            miniTitle: document.getElementById('miniTitle'), miniStatus: document.getElementById('miniStatus'), miniCover: document.getElementById('miniCover'),
            playIcon: document.getElementById('playIcon'), listContainer: document.getElementById('listContainer'),
            progress: document.getElementById('progressBar'), volume: document.getElementById('volumeBar'),
            currTime: document.getElementById('currentTime'), totTime: document.getElementById('totalTime'),
            displayUserName: document.getElementById('displayUserName'), btnAdmin: document.getElementById('btnAdmin'), userAvatar: document.getElementById('userAvatar')
        };
        
        let dragging = { progress: false, volume: false };
        let currentTab = 'queue';
        let queueData = { current: null, queue: [] };
        let historyData = [];
        let typingTimer;

        function connectSocket() {
            if (socket) return;
            socket = io({ auth: { token } });
            socket.on('connect_error', (err) => { if(err.message === "Token inválido" || err.message === "Não autorizado") doLogout(); });
            socket.on('user_info', (user) => { els.displayUserName.innerText = user.name; els.userAvatar.innerText = user.name.charAt(0).toUpperCase(); if(user.role === 'admin') els.btnAdmin.style.display = 'flex'; });
            socket.on('status', (data) => { queueData = data; updateHero(data); if(currentTab === 'queue') renderList(); });
            socket.on('history_data', (data) => { historyData = data; if(currentTab === 'history') renderList(); });
            socket.on('playerState', (st) => {
                els.playIcon.className = st.paused ? 'fas fa-play' : 'fas fa-pause';
                if (!st.isLoading && st.duration > 0 && !dragging.progress) {
                    els.progress.max = st.duration; els.progress.value = st.position;
                    els.currTime.innerText = fmt(st.position); els.totTime.innerText = fmt(st.duration);
                    updateBg(els.progress);
                }
                if (!dragging.volume) { els.volume.value = st.volume; updateBg(els.volume); }
            });
            socket.on('search_results', (results) => {
                els.searchLoader.style.display = 'none'; els.searchResults.innerHTML = '';
                if (!results.length) { els.searchResults.style.display = 'none'; return; }
                results.forEach(item => {
                    const thumb = item.thumbnail || 'https://via.placeholder.com/80x45?text=...';
                    els.searchResults.innerHTML += `<div class="result-item" onclick="addFromSearch('${item.url}')"><div class="result-thumb-wrapper"><img src="${thumb}" class="result-thumb"></div><div class="result-content"><div class="result-title">${item.title}</div></div></div>`;
                });
                els.searchResults.style.display = 'flex';
            });
        }

        els.url.addEventListener('input', () => {
            clearTimeout(typingTimer);
            const val = els.url.value.trim();
            if (!val || val.startsWith('http')) { els.searchResults.style.display = 'none'; els.searchLoader.style.display = 'none'; return; }
            els.searchLoader.style.display = 'block';
            typingTimer = setTimeout(() => { socket.emit('search', val); }, 500);
        });
        document.addEventListener('click', (e) => { if (!els.url.contains(e.target) && !els.searchResults.contains(e.target)) els.searchResults.style.display = 'none'; });

        function addFromSearch(url) { socket.emit('add', url); els.searchResults.style.display = 'none'; els.url.value = ''; showToast('Adicionado!'); }
        function addMusic() { if(els.url.value) { socket.emit('add', els.url.value); els.url.value = ''; showToast('Adicionado!'); } }
        function control(type) { socket.emit('control', { type }); }
        function jumpTo(id) { socket.emit('jump_to', id); }
        function replay(id) { socket.emit('replay_history', id); switchTab('queue'); showToast('Adicionado novamente'); }
        function fmt(s) { return !s || isNaN(s) ? "0:00" : `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
        
        // Update BG com suporte a Firefox e Webkit
        function updateBg(input) {
            const min = input.min || 0, max = input.max || 100, val = input.value;
            const percent = ((val - min) / (max - min)) * 100;
            // Apenas para webkit (chrome) pois firefox usa ::-moz-range-progress nativo
            input.style.backgroundSize = `${percent}% 100%`;
        }

        els.progress.addEventListener('input', (e) => { dragging.progress = true; updateBg(e.target); });
        els.progress.addEventListener('change', () => { dragging.progress = false; socket.emit('control', { type: 'seek', value: els.progress.value }); });
        els.volume.addEventListener('input', (e) => { updateBg(e.target); socket.emit('control', { type: 'set_volume', value: els.volume.value }); });

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            if (tab === 'history') socket.emit('get_history');
            renderList();
        }

        function updateHero(data) {
            const hasMusic = !!data.current;
            if (hasMusic) {
                els.idleState.style.display = 'none'; els.heroCover.style.display = 'block';
                els.heroCover.src = data.current.thumbnail; els.miniCover.src = data.current.thumbnail;
                els.heroTitle.innerText = data.current.title; els.heroStatus.innerText = "Adicionado por: " + (data.current.addedBy || 'User');
                els.miniTitle.innerText = data.current.title; els.miniStatus.innerText = "Tocando";
                els.miniCover.style.display = 'block';
            } else {
                els.idleState.style.display = 'flex'; els.heroCover.style.display = 'none';
                els.heroTitle.innerText = "Jukebox Parada"; els.heroStatus.innerText = "Adicione uma URL";
                els.miniTitle.innerText = ""; els.miniStatus.innerText = "";
                els.miniCover.style.display = 'none';
            }
        }

        function renderList() {
            els.listContainer.innerHTML = '';
            if (currentTab === 'queue') {
                if (queueData.current) {
                    els.listContainer.innerHTML += `<div class="list-item active"><img src="${queueData.current.thumbnail}" class="l-img"><div class="l-meta"><div class="l-name">${queueData.current.title}</div><div class="l-user">Adicionado por: ${queueData.current.addedBy || 'User'}</div></div><div class="l-icon"><i class="fas fa-volume-up"></i></div></div>`;
                }
                queueData.queue.forEach(t => {
                    els.listContainer.innerHTML += `<div class="list-item" onclick="jumpTo('${t._id}')"><img src="${t.thumbnail}" class="l-img"><div class="l-meta"><div class="l-name">${t.title}</div><div class="l-user">Adicionado por: ${t.addedBy || 'User'}</div></div><div class="l-action"><i class="fas fa-play"></i></div></div>`;
                });
                if(!queueData.current && queueData.queue.length === 0) els.listContainer.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">Fila vazia</div>';
            } else {
                historyData.forEach(t => {
                    els.listContainer.innerHTML += `<div class="list-item"><img src="${t.thumbnail}" class="l-img"><div class="l-meta"><div class="l-name">${t.title}</div><div class="l-user">Pedido por: ${t.requestedBy || 'User'}</div></div><div class="l-action" onclick="replay('${t._id}')"><i class="fas fa-redo"></i></div></div>`;
                });
                if(historyData.length === 0) els.listContainer.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">Histórico vazio</div>';
            }
        }

        init();
    </script>
</body>
</html>